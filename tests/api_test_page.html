<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Updated API Test Page</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                line-height: 1.6;
            }

            .card {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            button {
                background-color: #4CAF50;
                color: white;
                border: none;
                padding: 10px 15px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
                border-radius: 4px;
            }

            button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }

            pre {
                background-color: #f5f5f5;
                padding: 10px;
                border-radius: 4px;
                overflow-x: auto;
            }

            .error {
                color: #f44336;
            }

            .success {
                color: #4CAF50;
            }

            input {
                padding: 8px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
                width: 100%;
                box-sizing: border-box;
            }

            #debug-info {
                margin-top: 20px;
                border-top: 1px solid #ddd;
                padding-top: 10px;
                font-size: 12px;
                color: #666;
            }
        </style>
    </head>

    <body>
        <h1>Updated API Test Page</h1>

        <div class="card">
            <h2>Configuration</h2>
            <div>
                <label for="api-base-url">API Base URL:</label>
                <input type="text" id="api-base-url" value="http://localhost:8000/api/v1">
            </div>
        </div>

        <div class="card" id="login-section">
            <h2>Login</h2>
            <div>
                <label for="username">Hive Username:</label>
                <input type="text" id="username" placeholder="Enter your Hive username">
            </div>
            <button id="login-btn">Login with Keychain</button>
            <div>
                <h3>Login Status:</h3>
            <pre id="login-status">Not logged in</pre>
            </div>
        </div>

        <div class="card" id="logged-in-section" style="display: none;">
            <h2>User Information</h2>
            <p>Logged in as: <span id="logged-in-username">-</span></p>
            <p>User ID: <span id="user-id">-</span></p>
            <p>Token: <span id="token-display" style="font-size: 0.8em; word-break: break-all;">-</span></p>
            <button id="logout-btn">Logout</button>
            <button id="clear-token-btn" style="background-color: #f44336;">Clear Invalid Token</button>
        </div>

        <div class="card" id="balance-section" style="display: none;">
            <h2>Wallet Balance</h2>
            <button id="balance-btn">Refresh Balance</button>
            <div>
                <p>Gold: <span id="gold-balance">-</span></p>
                <p>Mithril: <span id="mithril-balance">-</span></p>
            </div>
        </div>

        <div class="card" id="transfer-section">
            <h2>Transfer Gold to User</h2>
            <div>
                <label for="recipient">Recipient:</label>
                <input type="text" id="recipient" placeholder="Enter recipient username">
            </div>
            <div>
                <label for="amount">Amount:</label>
                <input type="text" id="amount" placeholder="Enter amount">
            </div>
            <div>
                <label for="memo">Memo:</label>
                <input type="text" id="memo" placeholder="Optional memo">
            </div>
            <button id="transfer-btn" disabled>Transfer Gold</button>
            <div id="transfer-status"></div>
        </div>

        <div class="card">
            <h2>Spend Gold (System)</h2>
            <div>
                <label for="spend-amount">Amount:</label>
                <input type="text" id="spend-amount" placeholder="Enter amount">
            </div>
            <div>
                <label for="item-id">Item ID:</label>
                <input type="text" id="item-id" placeholder="Optional item identifier">
            </div>
            <div>
                <label for="spend-description">Description:</label>
                <input type="text" id="spend-description" placeholder="Optional description">
            </div>
            <button id="spend-btn" disabled>Spend Gold</button>
            <div id="spend-status"></div>
        </div>

        <div class="card">
            <h2>Debug Log</h2>
            <button id="clear-debug">Clear Log</button>
            <div id="debug-info"></div>
        </div>

        <script>
        // Helper function to log to both console and debug div
            function debugLog(message) {
                console.log(message);
                const debugDiv = document.getElementById('debug-info');
                const p = document.createElement('p');
                p.textContent = typeof message === 'object' ? JSON.stringify(message) : message;
                debugDiv.appendChild(p);
            }

        // Clear debug log
            document.getElementById('clear-debug').addEventListener('click', function () {
                document.getElementById('debug-info').innerHTML = '<p>Debug log cleared</p>';
            });

            document.addEventListener('DOMContentLoaded', function () {
            // Check if token exists in localStorage
                const token = localStorage.getItem('api_token');
                const username = localStorage.getItem('username');
                const userId = localStorage.getItem('user_id');

                if (token && username) {
                // Show logged in state
                    showLoggedInState(username, userId, token);
                }

            // Get current UTC datetime for signing
                function getCurrentUTCDateTime() {
                    const now = new Date();
                    return now.toISOString();
                }

            // Check if Hive Keychain is available
                async function checkKeychainAvailability(maxAttempts = 10, interval = 300) {
                    return new Promise((resolve) => {
                        let attempts = 0;

                        function check() {
                            attempts++;
                            debugLog(`Checking for Keychain (attempt ${attempts}/${maxAttempts})`);

                            if (typeof window.hive_keychain !== "undefined") {
                                debugLog("Hive Keychain detected!");
                                resolve(true);
                                return;
                            }

                            if (attempts >= maxAttempts) {
                                debugLog("Keychain not found after multiple attempts");
                                resolve(false);
                                return;
                            }

                            setTimeout(check, interval);
                        }

                        check();
                    });
                }

            // Login with Keychain
                async function loginWithKeychain(username) {
                // Check if Keychain is available
                    const keychainAvailable = await checkKeychainAvailability();
                    if (!keychainAvailable) {
                        document.getElementById('login-status').textContent =
                            'Hive Keychain extension not detected! Please install the extension and refresh this page.';
                        document.getElementById('login-status').className = 'error';
                        return;
                    }

                // Generate message to sign (current UTC datetime)
                    const datetimeToSign = getCurrentUTCDateTime();
                    debugLog(`Message to sign: ${datetimeToSign}`);

                // Request signature from Keychain
                    window.hive_keychain.requestSignBuffer(
                        username,
                        datetimeToSign,
                        "Posting", // Use posting authority
                        function (response) {
                            debugLog("Keychain response:");
                            debugLog(response);

                            if (!response.success) {
                                document.getElementById('login-status').textContent =
                                    response.message || "Keychain signature failed";
                                document.getElementById('login-status').className = 'error';
                                return;
                            }

                        // Get signature and public key
                            const proof = response.result;
                            const pubkey = response.publicKey ||
                            (response.data && response.data.publicKey) ||
                            null;

                            if (!pubkey) {
                                document.getElementById('login-status').textContent =
                                    "Could not retrieve public key from Keychain response";
                                document.getElementById('login-status').className = 'error';
                                return;
                            }

                        // Prepare payload for API
                            const payload = {
                                challenge: proof, // The signature
                                username: username, // Hive username
                                pubkey: pubkey, // Public key used for signing
                                proof: datetimeToSign, // The message that was signed
                            };

                            debugLog(`Sending request to: ${document.getElementById('api-base-url').value}/login`);
                            debugLog("Payload:");
                            debugLog(payload);

                        // Send to API
                            fetch(`${document.getElementById('api-base-url').value}/login`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Accept": "application/json"
                                },
                                body: JSON.stringify(payload),
                                credentials: "include" // Include cookies in the request
                            })
                                .then(async (response) => {
                                    debugLog(`Response status: ${response.status}`);
                                    debugLog("Response headers:");
                                    debugLog(Object.fromEntries([...response.headers]));

                                    if (!response.ok) {
                                        const errorText = await response.text();
                                        debugLog("Error response:");
                                        debugLog(errorText);
                                        throw new Error(errorText || `HTTP error! status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then((data) => {
                                    debugLog("Response body:");
                                    debugLog(data);

                                    if (data.success) {
                                    // Store token in localStorage for later API requests
                                        if (data.token) {
                                            localStorage.setItem('api_token', data.token);
                                            localStorage.setItem('username', data.username);
                                            localStorage.setItem('user_id', data.user_id);
                                        }

                                        document.getElementById('login-status').textContent =
                                            `Login successful! Welcome, ${data.username}`;
                                        document.getElementById('login-status').className = 'success';

                                    // Show logged in state
                                        showLoggedInState(data.username, data.user_id, data.token);
                                    } else {
                                        document.getElementById('login-status').textContent =
                                            data.error || "Login failed";
                                        document.getElementById('login-status').className = 'error';
                                    }
                                })
                                .catch((error) => {
                                    debugLog("Login error:");
                                    debugLog(error);
                                    document.getElementById('login-status').textContent =
                                        error.message || "Unknown error occurred";
                                    document.getElementById('login-status').className = 'error';
                                });
                        }
                    );
                }

            // Show logged in state
                function showLoggedInState(username, userId, token) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('logged-in-section').style.display = 'block';
                    document.getElementById('logged-in-username').textContent = username;
                    document.getElementById('user-id').textContent = userId;
                    document.getElementById('token-display').textContent = token;
                    document.getElementById('balance-section').style.display = 'block';
                    document.getElementById('transfer-section').style.display = 'block';

                // Enable transfer and spend buttons
                    document.getElementById('transfer-btn').disabled = false;
                    document.getElementById('spend-btn').disabled = false;

                // Store in localStorage for persistence
                    localStorage.setItem('username', username);
                    localStorage.setItem('user_id', userId);
                    localStorage.setItem('api_token', token);
                }

            // Show logged out state
                function showLoggedOutState() {
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('logged-in-section').style.display = 'none';
                    document.getElementById('balance-section').style.display = 'none';
                    document.getElementById('transfer-section').style.display = 'none';

                // Disable transfer and spend buttons
                    document.getElementById('transfer-btn').disabled = true;
                    document.getElementById('spend-btn').disabled = true;

                    document.getElementById('login-status').textContent = 'Not logged in';
                    document.getElementById('login-status').className = '';
                }

            // Fetch balance
                function fetchBalance() {
                    const token = localStorage.getItem('api_token');
                    if (!token) {
                        debugLog('No token found');
                        return;
                    }

                // Get the API URL
                    const apiBaseUrl = document.getElementById('api-base-url').value.trim();
                    const balanceUrl = `${apiBaseUrl}/balance`;

                // Update UI
                    document.getElementById('gold-balance').textContent = 'Loading...';
                    document.getElementById('mithril-balance').textContent = 'Loading...';

                    debugLog(`Fetching balance from: ${balanceUrl}`);
                    debugLog(`Using token: ${token}`);

                // Fetch balance from API
                    fetch(balanceUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        },
                        credentials: 'include' // Include cookies in the request
                    })
                        .then(response => {
                            debugLog(`Response status: ${response.status}`);
                            debugLog("Response headers:");
                            debugLog(Object.fromEntries([...response.headers]));

                            if (!response.ok) {
                                return response.json().then(data => {
                                    debugLog("Error response:");
                                    debugLog(data);
                                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            debugLog("Response body:");
                            debugLog(data);

                            if (data.success) {
                            // Update balance display
                                document.getElementById('gold-balance').textContent = data.balances?.gold || 'N/A';
                                document.getElementById('mithril-balance').textContent = data.balances?.mithril || 'N/A';
                            } else {
                                throw new Error(data.error || 'Unknown error');
                            }
                        })
                        .catch(error => {
                            debugLog("Error fetching balance:");
                            debugLog(error);
                            document.getElementById('gold-balance').textContent = 'Error';
                            document.getElementById('mithril-balance').textContent = 'Error';

                            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                            // Token might be expired
                                document.getElementById('login-status').textContent =
                                    'Your session has expired or token is invalid. Please clear the token and login again.';
                                document.getElementById('login-status').className = 'error';
                                document.getElementById('login-section').style.display = 'block';

                            // Show a message in the balance section
                                const balanceError = document.createElement('div');
                                balanceError.className = 'error';
                                balanceError.textContent = 'Authentication failed. Please clear the invalid token and login again.';
                                document.getElementById('balance-section').appendChild(balanceError);
                            }
                        });
                }

            // Transfer gold
                function transferGold(recipient, amount, memo) {
                    const token = localStorage.getItem('api_token');
                    if (!token) {
                        debugLog('No token found');
                        return;
                    }

                // Validate inputs
                    if (!recipient || !amount) {
                        document.getElementById('transfer-status').textContent =
                            'Please enter recipient and amount';
                        document.getElementById('transfer-status').className = 'error';
                        return;
                    }

                // Get the API URL
                    const apiBaseUrl = document.getElementById('api-base-url').value.trim();
                    const transferUrl = `${apiBaseUrl}/send`;

                // Prepare payload
                    const payload = {
                        recipient: recipient,
                        amount: amount,
                        description: memo || ''  // API expects 'description' not 'memo'
                    };

                // Update UI
                    document.getElementById('transfer-status').textContent = 'Processing transfer...';
                    document.getElementById('transfer-status').className = '';

                    debugLog(`Sending transfer request to: ${transferUrl}`);
                    debugLog("Transfer payload:");
                    debugLog(payload);

                // Send transfer request
                    fetch(transferUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        credentials: 'include' // Include cookies in the request
                    })
                        .then(response => {
                            debugLog(`Response status: ${response.status}`);
                            debugLog("Response headers:");
                            debugLog(Object.fromEntries([...response.headers]));

                            if (!response.ok) {
                                return response.json().then(data => {
                                    debugLog("Error response:");
                                    debugLog(data);
                                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            debugLog("Response body:");
                            debugLog(data);

                            if (data.success) {
                            // Update status display
                                let successMessage = `Transfer successful! Transaction ID: ${data.transaction.id}
New balance: ${data.balance.gold} gold`;

                            // Add memo if available
                                if (data.transaction.memo) {
                                    successMessage += `
Memo: ${data.transaction.memo}`;
                                }

                                document.getElementById('transfer-status').textContent = successMessage;
                                document.getElementById('transfer-status').className = 'success';

                            // Clear form
                                document.getElementById('recipient').value = '';
                                document.getElementById('amount').value = '';
                                document.getElementById('memo').value = '';

                            // Refresh balance
                                fetchBalance();
                            } else {
                                throw new Error(data.error || 'Unknown error');
                            }
                        })
                        .catch(error => {
                            debugLog("Error transferring gold:");
                            debugLog(error);
                            document.getElementById('transfer-status').textContent =
                                `Error: ${error.message}`;
                            document.getElementById('transfer-status').className = 'error';

                            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                            // Token might be expired
                                alert('Your session has expired. Please login again.');
                                localStorage.removeItem('api_token');
                                localStorage.removeItem('username');
                                localStorage.removeItem('user_id');
                                showLoggedOutState();
                            }
                        });
                }

            // Spend gold on system services
                function spendGold(amount, itemId, description) {
                    const token = localStorage.getItem('api_token');
                    if (!token) {
                        debugLog('No token found');
                        return;
                    }

                // Validate inputs
                    if (!amount) {
                        document.getElementById('spend-status').textContent =
                            'Please enter an amount';
                        document.getElementById('spend-status').className = 'error';
                        return;
                    }

                // Get the API URL
                    const apiBaseUrl = document.getElementById('api-base-url').value.trim();
                    const spendUrl = `${apiBaseUrl}/spend`;

                // Prepare payload
                    const payload = {
                        amount: amount
                    };

                // Add optional fields if provided
                    if (description) {
                        payload.description = description;
                    }
                    if (itemId) {
                        payload.item_id = itemId;
                    }

                // Update UI
                    document.getElementById('spend-status').textContent = 'Processing spend...';
                    document.getElementById('spend-status').className = '';

                    debugLog(`Sending spend request to: ${spendUrl}`);
                    debugLog("Spend payload:");
                    debugLog(payload);

                // Send spend request
                    fetch(spendUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        credentials: 'include' // Include cookies in the request
                    })
                        .then(response => {
                            debugLog(`Response status: ${response.status}`);

                        // Log response headers
                            const headers = {};
                            response.headers.forEach((value, key) => {
                                headers[key] = value;
                            });
                            debugLog("Response headers:");
                            debugLog(headers);

                            if (!response.ok) {
                                return response.json().then(data => {
                                    debugLog("Error response:");
                                    debugLog(data);
                                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            debugLog("Response body:");
                            debugLog(data);

                            if (data.success) {
                            // Update status display
                                let successMessage = `Spend successful! Transaction ID: ${data.transaction.id}
New balance: ${data.balance.gold} gold`;

                            // Add memo if available
                                if (data.transaction.memo) {
                                    successMessage += `
Memo: ${data.transaction.memo}`;
                                }

                                document.getElementById('spend-status').textContent = successMessage;
                                document.getElementById('spend-status').className = 'success';

                            // Clear form
                                document.getElementById('spend-amount').value = '';
                                document.getElementById('item-id').value = '';
                                document.getElementById('spend-description').value = '';

                            // Refresh balance
                                fetchBalance();
                            } else {
                                throw new Error(data.error || 'Unknown error');
                            }
                        })
                        .catch(error => {
                            debugLog("Error spending gold:");
                            debugLog(error);
                            document.getElementById('spend-status').textContent =
                                `Error: ${error.message}`;
                            document.getElementById('spend-status').className = 'error';
                        });
                }

            // Event listeners
                document.getElementById('login-btn').addEventListener('click', function () {
                    const username = document.getElementById('username').value.trim();
                    if (!username) {
                        document.getElementById('login-status').textContent = 'Please enter your Hive username';
                        document.getElementById('login-status').className = 'error';
                        return;
                    }
                    loginWithKeychain(username);
                });

                document.getElementById('logout-btn').addEventListener('click', function () {
                    localStorage.removeItem('api_token');
                    localStorage.removeItem('username');
                    localStorage.removeItem('user_id');
                    showLoggedOutState();
                    debugLog('User logged out');
                });

                document.getElementById('clear-token-btn').addEventListener('click', function () {
                    localStorage.removeItem('api_token');
                    localStorage.removeItem('username');
                    localStorage.removeItem('user_id');
                    showLoggedOutState();
                    debugLog('Invalid token cleared');
                    document.getElementById('login-status').textContent = 'Token cleared. Please login again.';
                });

                document.getElementById('balance-btn').addEventListener('click', fetchBalance);

                document.getElementById('transfer-btn').addEventListener('click', function () {
                    const recipient = document.getElementById('recipient').value.trim();
                    const amount = document.getElementById('amount').value.trim();
                    const memo = document.getElementById('memo').value.trim();
                    transferGold(recipient, amount, memo);
                });

                document.getElementById('spend-btn').addEventListener('click', function () {
                    const amount = document.getElementById('spend-amount').value.trim();
                    const itemId = document.getElementById('item-id').value.trim();
                    const description = document.getElementById('spend-description').value.trim();
                    spendGold(amount, itemId, description);
                });

            // Initial check for Keychain
                checkKeychainAvailability().then(available => {
                    if (!available) {
                        document.getElementById('login-status').textContent =
                            'Hive Keychain extension not detected! Please install the extension and refresh this page.';
                        document.getElementById('login-status').className = 'error';
                    }

                // Check for existing login
                    const savedToken = localStorage.getItem('api_token');
                    const savedUsername = localStorage.getItem('username');
                    const savedUserId = localStorage.getItem('user_id');

                    if (savedToken && savedUsername) {
                    // Restore logged in state
                        showLoggedInState(savedUsername, savedUserId, savedToken);
                        debugLog(`Restored session for ${savedUsername}`);

                    // Fetch balance with the saved token
                        fetchBalance();
                    } else {
                    // Make sure buttons are disabled
                        document.getElementById('transfer-btn').disabled = true;
                        document.getElementById('spend-btn').disabled = true;
                    }
                });
            });
        </script>

    <!-- Include Hive Keychain JS -->
        <script src="https://cdn.jsdelivr.net/npm/hive-keychain-js@latest/dist/hive-keychain-js.min.js"></script>
    </body>

</html>