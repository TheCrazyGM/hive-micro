<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Expired Timestamp</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 15px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .error {
        color: #f44336;
      }
      .success {
        color: #4caf50;
      }
      input {
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
      }
      select {
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
      }
      label {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Test Expired Timestamp Authentication</h1>

    <div class="card">
      <h2>Test Configuration</h2>
      <div>
        <label for="api-url">API URL:</label>
        <input
          type="text"
          id="api-url"
          value="http://localhost:8000/api/v1/login"
          style="width: 100%"
        />
        <small
        >Change this to match your Flask server URL (e.g.,
          http://localhost:8000/api/v1/login)</small
          >
        </div>
        <div>
          <label for="username">Hive Username:</label>
          <input
            type="text"
            id="username"
            placeholder="Enter your Hive username"
          />
        </div>
        <div>
          <label for="timestamp-type">Timestamp Type:</label>
          <select id="timestamp-type">
            <option value="current">Current Time (Should Pass)</option>
            <option value="expired">
              Expired Time - 10 minutes ago (Should Fail)
            </option>
            <option value="future">
              Future Time - 10 minutes ahead (Should Fail)
            </option>
            <option value="invalid">Invalid Format (Should Fail)</option>
            <option value="custom">Custom Minutes Offset</option>
          </select>
        </div>
        <div id="custom-offset-container" style="display: none">
          <label for="minutes-offset"
          >Minutes Offset (negative = past, positive = future):</label
            >
            <input type="number" id="minutes-offset" value="-10" />
          </div>
          <button id="test-login-btn">Test Login</button>
        </div>

        <div class="card">
          <h2>Request Details</h2>
      <pre id="request-details">No request made yet</pre>
        </div>

        <div class="card">
          <h2>Response</h2>
      <pre id="response-details">No response received yet</pre>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
        // Show/hide custom offset input based on selection
            document
              .getElementById("timestamp-type")
              .addEventListener("change", function () {
                const customOffsetContainer = document.getElementById(
                  "custom-offset-container",
                );
                customOffsetContainer.style.display =
                  this.value === "custom" ? "block" : "none";
              });

        // Function to generate a timestamp with offset
            function generateTimestamp(type) {
              const now = new Date();

              switch (type) {
                case "current":
                  return now.toISOString();
                case "expired":
              // 10 minutes ago
                  now.setMinutes(now.getMinutes() - 10);
                  return now.toISOString();
                case "future":
              // 10 minutes in the future
                  now.setMinutes(now.getMinutes() + 10);
                  return now.toISOString();
                case "invalid":
              // Invalid format
                  return "2025-06-01T09:25:22";
                case "custom":
              // Custom minutes offset
                  const offset = parseInt(
                    document.getElementById("minutes-offset").value,
                  );
                  now.setMinutes(now.getMinutes() + offset);
                  return now.toISOString();
                default:
                  return now.toISOString();
              }
            }

        // Test login button click handler
            document
              .getElementById("test-login-btn")
              .addEventListener("click", function () {
                const username = document.getElementById("username").value.trim();
                if (!username) {
                  alert("Please enter a Hive username");
                  return;
                }

                const timestampType =
                  document.getElementById("timestamp-type").value;
                const datetimeToSign = generateTimestamp(timestampType);

            // Check if Keychain is available
                if (typeof window.hive_keychain === "undefined") {
                  document.getElementById("response-details").innerHTML =
                    '<span class="error">Hive Keychain extension not detected! Please install the extension and refresh this page.</span>';
                  return;
                }

            // Display the timestamp that will be used
                document.getElementById("request-details").innerHTML =
                  `Username: ${username}\nTimestamp to sign: ${datetimeToSign}\n\nWaiting for Keychain signature...`;

            // Request signature from Keychain
                window.hive_keychain.requestSignBuffer(
                  username,
                  datetimeToSign,
                  "Posting", // Use posting authority
                  function (response) {
                    if (!response.success) {
                      document.getElementById("response-details").innerHTML =
                        `<span class="error">Keychain signature failed: ${response.message || "Unknown error"}</span>`;
                      return;
                    }

                // Get signature and public key
                    const proof = response.result;
                    const pubkey =
                      response.publicKey ||
                    (response.data && response.data.publicKey) ||
                    null;

                    if (!pubkey) {
                      document.getElementById("response-details").innerHTML =
                        '<span class="error">Could not retrieve public key from Keychain response</span>';
                      return;
                    }

                // Prepare payload for API
                    const payload = {
                      challenge: proof, // The signature
                      username: username, // Hive username
                      pubkey: pubkey, // Public key used for signing
                      proof: datetimeToSign, // The message that was signed
                    };

                // Update request details
                    document.getElementById("request-details").innerHTML =
                      `Username: ${username}\nTimestamp signed: ${datetimeToSign}\nPublic Key: ${pubkey}\n\nSending request to API...`;

                // Get the API URL from the input field
                    const apiUrl = document.getElementById("api-url").value.trim();
                    document.getElementById("request-details").innerHTML += `
API URL: ${apiUrl}`;

                    fetch(apiUrl, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json",
                      },
                      body: JSON.stringify(payload),
                      mode: "cors", // Explicitly set CORS mode
                      credentials: "include", // Use include instead of same-origin for better cross-origin support
                    })
                      .then(async (response) => {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.includes("text/html")) {
                          const htmlError = await response.text();
                          throw new Error(
                            "Server returned HTML instead of JSON. Check CSRF protection or server errors.",
                          );
                        }

                        const responseText = await response.text();
                        let responseData;
                        try {
                          responseData = JSON.parse(responseText);
                        } catch (e) {
                          throw new Error(
                            `Failed to parse response: ${responseText.substring(0, 100)}...`,
                          );
                        }

                    // Format the response for display
                        let formattedResponse = JSON.stringify(
                          responseData,
                          null,
                          2,
                        );
                        let statusClass = response.ok ? "success" : "error";
                        let statusText = `HTTP Status: ${response.status} ${response.statusText}`;

                        document.getElementById("response-details").innerHTML =
                          `<div class="${statusClass}">${statusText}</div>\n${formattedResponse}`;

                        return responseData;
                      })
                      .catch((error) => {
                        console.error("API Login error:", error);
                        document.getElementById("response-details").innerHTML =
                          `<span class="error">Error: ${error.message || "Unknown error occurred"}</span>`;
                      });
                  },
                );
              });
          });
        </script>
      </body>
    </html>
