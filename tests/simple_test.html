<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Simple API Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }

            .card {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            button {
                background-color: #4CAF50;
                color: white;
                border: none;
                padding: 10px 15px;
                margin: 5px 0;
                cursor: pointer;
                border-radius: 4px;
            }

            pre {
                background-color: #f5f5f5;
                padding: 10px;
                border-radius: 4px;
                overflow-x: auto;
            }

            input {
                padding: 8px;
                margin: 5px 0;
                width: 100%;
                box-sizing: border-box;
            }
        </style>
    </head>

    <body>
        <h1>Simple API Test</h1>

        <div class="card">
            <h2>API Configuration</h2>
            <div>
                <label for="api-url">API Base URL:</label>
                <input type="text" id="api-url" value="http://localhost:8000/api/v1">
            </div>
        </div>

        <div class="card">
            <h2>API Test Page</h2>
            <p>This page tests the API login and balance endpoints using Hive Keychain.</p>
            <p><strong>Note:</strong> The API now uses the same authentication system as the web application, ensuring
                compatibility between both.</p>
            <div>
                <label for="username">Hive Username:</label>
                <input type="text" id="username" placeholder="Enter your Hive username">
            </div>
            <button id="login-btn">Login with Keychain</button>
            <div>
                <h3>Response:</h3>
            <pre id="login-response">Click login to see response</pre>
            </div>
        </div>

        <div class="card">
            <h2>Balance Test</h2>
            <div>
                <label for="token">Bearer Token:</label>
                <input type="text" id="token" placeholder="Enter token from login response">
            </div>
            <button id="balance-btn">Get Balance</button>
            <button id="clear-debug">Clear Debug Log</button>
            <div>
                <h3>Response:</h3>
            <pre id="balance-response">Click get balance to see response</pre>
            </div>
        </div>

        <div class="card">
            <h2>Debug Info</h2>
            <div id="debug-info">
                <p>Console logs will appear here</p>
            </div>
        </div>

        <script>
        // Helper function to log to both console and debug div
            function debugLog(message) {
                console.log(message);
                const debugDiv = document.getElementById('debug-info');
                const p = document.createElement('p');
                p.textContent = typeof message === 'object' ? JSON.stringify(message) : message;
                debugDiv.appendChild(p);
            }

        // Clear debug log
            document.getElementById('clear-debug').addEventListener('click', function () {
                document.getElementById('debug-info').innerHTML = '<p>Debug log cleared</p>';
            });

        // Get current UTC datetime for signing
            function getCurrentUTCDateTime() {
                return new Date().toISOString();
            }

        // Login button click handler
            document.getElementById('login-btn').addEventListener('click', function () {
                const username = document.getElementById('username').value.trim();
                if (!username) {
                    alert('Please enter a username');
                    return;
                }

                debugLog('Checking for Hive Keychain...');

            // Check if Keychain is available
                if (typeof window.hive_keychain === 'undefined') {
                    debugLog('Hive Keychain not found. Please install the extension.');
                    document.getElementById('login-response').textContent = 'Error: Hive Keychain not found';
                    return;
                }

                debugLog('Hive Keychain found. Requesting signature...');

            // Generate message to sign (current UTC datetime)
                const datetimeToSign = getCurrentUTCDateTime();
                debugLog('Message to sign: ' + datetimeToSign);

            // Request signature from Keychain
                window.hive_keychain.requestSignBuffer(
                    username,
                    datetimeToSign,
                    'Posting',
                    function (response) {
                        debugLog('Keychain response:');
                        debugLog(response);

                        if (!response.success) {
                            document.getElementById('login-response').textContent = 'Keychain error: ' + response.message;
                            return;
                        }

                    // Get API URL
                        const apiUrl = document.getElementById('api-url').value.trim() + '/login';
                        debugLog('Sending request to: ' + apiUrl);

                    // Prepare payload
                        const payload = {
                            challenge: response.result,
                            username: username,
                            pubkey: response.publicKey,
                            proof: datetimeToSign
                        };

                        debugLog('Payload:');
                        debugLog(payload);

                    // Send to API
                        fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(payload),
                            mode: 'cors',
                            credentials: 'include'
                        })
                            .then(response => {
                                debugLog('Response status: ' + response.status);
                                debugLog('Response headers:');
                                const headers = {};
                                response.headers.forEach((value, key) => {
                                    headers[key] = value;
                                });
                                debugLog(headers);

                                return response.text().then(text => {
                                    try {
                                        return { json: JSON.parse(text), text, status: response.status };
                                    } catch (e) {
                                        return { text, status: response.status, parseError: e.message };
                                    }
                                });
                            })
                            .then(result => {
                                debugLog('Response body:');
                                debugLog(result);

                            // Display response
                                document.getElementById('login-response').textContent =
                                    JSON.stringify(result.json || { text: result.text }, null, 2);

                            // If successful, populate token field
                                if (result.json && result.json.success && result.json.token) {
                                    document.getElementById('token').value = result.json.token;
                                }
                            })
                            .catch(error => {
                                debugLog('Fetch error:');
                                debugLog(error);
                                document.getElementById('login-response').textContent = 'Fetch error: ' + error.message;
                            });
                    }
                );
            });

        // Balance button click handler
            document.getElementById('balance-btn').addEventListener('click', function () {
                const token = document.getElementById('token').value.trim();
                if (!token) {
                    alert('Please enter a token');
                    return;
                }

            // Get API URL
                const apiUrl = document.getElementById('api-url').value.trim() + '/balance';
                debugLog('Fetching balance from: ' + apiUrl);
                debugLog('Using token: ' + token);

            // Fetch balance
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                })
                    .then(response => {
                        debugLog('Response status: ' + response.status);
                        debugLog('Response headers:');
                        const headers = {};
                        response.headers.forEach((value, key) => {
                            headers[key] = value;
                        });
                        debugLog(headers);

                        return response.text().then(text => {
                            try {
                                return { json: JSON.parse(text), text, status: response.status };
                            } catch (e) {
                                return { text, status: response.status, parseError: e.message };
                            }
                        });
                    })
                    .then(result => {
                        debugLog('Response body:');
                        debugLog(result);

                    // Display response
                        document.getElementById('balance-response').textContent =
                            JSON.stringify(result.json || { text: result.text }, null, 2);
                    })
                    .catch(error => {
                        debugLog('Fetch error:');
                        debugLog(error);
                        document.getElementById('balance-response').textContent = 'Fetch error: ' + error.message;
                    });
            });
        </script>

    <!-- Include Hive Keychain JS -->
        <script src="https://cdn.jsdelivr.net/npm/hive-keychain-js@latest/dist/hive-keychain-js.min.js"></script>
    </body>

</html>